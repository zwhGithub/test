(window.webpackJsonp=window.webpackJsonp||[]).push([[7],{807:function(t,a,s){"use strict";s.r(a);var e=s(114),c=Object(e.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"优化打包、速度"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#优化打包、速度"}},[t._v("#")]),t._v(" 优化打包、速度")]),t._v(" "),s("div",{staticClass:"custom-block warning"},[s("p",{staticClass:"custom-block-title"},[t._v("WARNING")]),t._v(" "),s("p",[t._v("Docker 的层用于保存镜像的上一版本和当前版本之间的差异。就像 Git 的提交一样，如果你与其他存储库或镜像共享它们，就会很方便。")])]),t._v(" "),s("h2",{attrs:{id:"镜像是有很多层"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#镜像是有很多层"}},[t._v("#")]),t._v(" 镜像是有很多层")]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),s("p",[t._v("大家在定义 Dockerfile 时，如果太多的使用 RUN 指令，经常会导致镜像有特别多的层，镜像很臃肿，而且甚至会碰到超出最大层数（127层）限制的问题，遵循 Dockerfile 最佳实践，我们应该把多个命令串联合并为一个 RUN（通过运算符&&和/ 来实现），每一个 RUN 要精心设计，确保安装构建最后进行清理，这样才可以降低镜像体积，以及最大化的利用构建缓存。")])]),t._v(" "),s("p",[s("strong",[t._v("当前并不是只使用一条RUN的指令就好")])]),t._v(" "),s("p",[s("strong",[t._v("构建业务服务镜像技巧")])]),t._v(" "),s("blockquote",[s("p",[t._v("Docker 在 build 镜像的时候，如果某个命令相关的内容没有变化，会使用上一次缓存（cache）的文件层，在构建业务镜像的时候可以注意下面三点。")])]),t._v(" "),s("ul",[s("li",[t._v("不变或者变化很少的体积较大的依赖库和经常修改的自有代码分开。")]),t._v(" "),s("li",[t._v("因为 cache 缓存在运行 Docker build 命令的本地机器上，建议固定使用某台机器来进行 Docker build，以便利用 cache。")]),t._v(" "),s("li",[t._v("用好缓存和基础镜像, 经常变更的层放后面。")])]),t._v(" "),s("h2",{attrs:{id:"dockerfile-构建技巧"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#dockerfile-构建技巧"}},[t._v("#")]),t._v(" dockerfile 构建技巧")]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),s("ul",[s("li",[t._v("多阶段构建、如npm i 单独构建。")]),t._v(" "),s("li",[t._v("npm 的时候 npm install —production  (部分项目全部node_modules都下载下来了)。")]),t._v(" "),s("li",[t._v(".dockerignore忽略一些生产环境的代码执行没有帮助的。(如：test .gitlab-ci.yml 等等，我试验过，大约可以减少5M体积。)")])])]),t._v(" "),s("h3",{attrs:{id:"来个简单的示例"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#来个简单的示例"}},[t._v("#")]),t._v(" 来个简单的示例")]),t._v(" "),s("div",{staticClass:"language-dockerfile extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v('FROM node:10-alpine\n\nWORKDIR /usr/src/app\n\nRUN apk --update add tzdata \\\n    && cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \\\n    && echo "Asia/Shanghai" > /etc/timezone \\\n    && apk del tzdata \\\n    && mkdir -p /usr/src/app\n\n# add npm package\nCOPY package.json /usr/src/app/package.json\n\nRUN npm i --production --registry=https://registry.npm.taobao.org\n\n# copy code\nCOPY . /usr/src/app\n\nEXPOSE 7001\n\nCMD npm start\n')])])])])}),[],!1,null,null,null);a.default=c.exports}}]);